<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sibuyas for All - Finance Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #CD853F 100%);
            min-height: 100vh;
            position: relative;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #8B4513;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .onion-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .subtitle {
            color: #654321;
            font-size: 1.2rem;
            font-weight: 300;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            color: #8B4513;
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #654321;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #DEB887;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #8B4513;
            box-shadow: 0 0 10px rgba(139, 69, 19, 0.3);
        }

        .btn {
            background: linear-gradient(45deg, #8B4513, #D2691E);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #CD853F, #DEB887);
            color: #654321;
        }

        .places-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .places-table th, .places-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #DEB887;
        }

        .places-table th {
            background: linear-gradient(45deg, #8B4513, #D2691E);
            color: white;
            font-weight: 500;
        }

        .places-table tr:hover {
            background: rgba(139, 69, 19, 0.1);
            cursor: pointer;
        }

        .transaction-item {
            background: rgba(222, 184, 135, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #8B4513;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.2);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .transaction-name {
            font-weight: bold;
            color: #8B4513;
        }

        .transaction-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #654321;
        }

        .transaction-type {
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 15px;
            color: white;
        }

        .cash { background: #22C55E; }
        .borrowed { background: #EF4444; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #8B4513, #D2691E);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(139, 69, 19, 0.95);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    transform: translateX(400px);
    transition: transform 0.5s ease;
    z-index: 1000;
    max-width: 300px;
    word-wrap: break-word;
    backdrop-filter: blur(10px);
}

.notification.show {
    transform: translateX(0);
}

/* Responsive adjustments for notifications */
@media (max-width: 768px) {
    .notification {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
        width: auto;
        transform: translateY(-100px);
        padding: 12px 16px;
        font-size: 0.9rem;
        .notification {
        right: 10px;
        left: 10px;
        max-width: none;
    }
    
    .notification.show {
        transform: translateY(0);
    }
}

@media (max-width: 480px) {
    .notification {
        top: 10px;
        right: 5px;
        left: 5px;
        padding: 10px 12px;
        font-size: 0.85rem;
        border-radius: 8px;
    }
    
    .notification-close {
        top: 3px;
        right: 8px;
        font-size: 1rem;
    }
}

/* For very small screens */
@media (max-width: 320px) {
    .notification {
        padding: 8px 10px;
        font-size: 0.8rem;
        max-height: 80px;
        overflow-y: auto;
    }
}

        .back-btn {
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .performance-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .performance-btn {
            padding: 8px 16px;
            border: 2px solid #8B4513;
            background: transparent;
            color: #8B4513;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .performance-btn.active, .performance-btn:hover {
            background: #8B4513;
            color: white;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .onion-icon {
                font-size: 2rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .performance-selector {
                justify-content: center;
            }
            
            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .app-container {
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        .paid {
    background: #10B981 !important;
    text-decoration: line-through;
    opacity: 0.7;
}

.transaction-item.paid-transaction {
    opacity: 0.8;
    background: rgba(16, 185, 129, 0.1);
}
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="onion-icon">üßÖ</div>
            <h1>Sibuyas for All</h1>
            <p class="subtitle">Your Complete Onion Business Finance Tracker</p>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view">
            <div class="main-content">
                <div class="sidebar">
                    <h2 class="section-title">
                        üè™ Add New Place
                    </h2>
                    <form id="place-form" onsubmit="return false;">
                        <div class="form-group">
                            <label for="place-name">Place Name</label>
                            <input type="text" id="place-name" placeholder="Enter place name" required>
                        </div>
                        <button type="button" class="btn" onclick="addPlaceHandler()">Add Place</button>
                    </form>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-places">0</div>
                            <div class="stat-label">Total Places</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-revenue">‚Ç±0</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-borrowed">‚Ç±0</div>
                            <div class="stat-label">Total Borrowed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="net-profit">‚Ç±0</div>
                            <div class="stat-label">Net Profit</div>
                        </div>
                        <div class="stat-card">
    <div class="stat-value" id="total-equity">‚Ç±0</div>
    <div class="stat-label">Total Equity</div>
</div>
                    </div>
                </div>

                <div class="content-area">
                    <h2 class="section-title">
                        üìç Business Places
                    </h2>
                    <table class="places-table" id="places-table">
                        <thead>
                            <tr>
                                <th>Place Name</th>
                                <th>Total Transactions</th>
                                <th>Revenue</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="places-tbody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: #999; padding: 40px;">
                                    No places added yet. Add your first business location!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="performance-selector">
                <button class="performance-btn active" data-period="week">This Week</button>
                <button class="performance-btn" data-period="month">This Month</button>
                <button class="performance-btn" data-period="year">This Year</button>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 style="color: #8B4513; margin-bottom: 15px;">üìä Revenue vs Borrowed</h3>
                    <canvas id="revenue-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 style="color: #8B4513; margin-bottom: 15px;">üìà Actual Performance Trend</h3>
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Place Detail View -->
        <div id="place-view" class="hidden">
            <button class="btn btn-secondary back-btn" onclick="showDashboard()">‚Üê Back to Dashboard</button>
            
            <div class="main-content">
                <div class="sidebar">
                    <h2 class="section-title" id="place-title">
                        üßÖ Add Transaction
                    </h2>
                    <form id="transaction-form" onsubmit="return false;">
                        <div class="form-group">
                            <label for="transaction-name">Transaction Name</label>
                            <input type="text" id="transaction-name" placeholder="Enter transaction description" required>
                        </div>
                        <div class="form-group">
                            <label for="transaction-amount">Amount (‚Ç±)</label>
                            <input type="number" id="transaction-amount" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="transaction-type">Payment Type</label>
                            <select id="transaction-type" required>
                                <option value="">Select payment type</option>
                                <option value="cash">Cash</option>
                                <option value="borrowed">Borrowed</option>
                            </select>
                        </div>
                        <div class="form-group">
    <label for="transaction-equity">Expected Equity/Profit (‚Ç±)</label>
    <input type="number" id="transaction-equity" placeholder="0.00" step="0.01" required>
</div>
                        <button type="button" class="btn" onclick="addTransactionHandler()">Add Transaction</button>
                    </form>
                </div>

                <div class="content-area">
                    <h2 class="section-title">
                        üí∞ Transaction History
                    </h2>
                    <div id="transactions-container">
                        <p style="text-align: center; color: #999; padding: 40px;">
                            No transactions yet. Add your first transaction!
                        </p>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3 style="color: #8B4513; margin-bottom: 15px;">üíπ Place Performance</h3>
                    <canvas id="place-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <button class="notification-close" onclick="hideNotification()">√ó</button>
        <div id="notification-message"></div>
    </div>

    <script>
        // App State
        let places = [];
        let currentPlace = null;
        let currentPeriod = 'week';

        // Initialize Charts
        let revenueChart, performanceChart, placeChart;

        document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing app...'); // Debug log
    
    // Load saved data first
    loadData();
    
    // Initialize the app
    updateStats();
    updateCharts();
    updatePlacesTable();
    
    // Welcome message
    setTimeout(() => {
        if (places.length === 0) {
            showNotification('Welcome to Sibuyas for All! üßÖ Start by adding your first business location.');
        } else {
            showNotification('Welcome back! Your data has been restored. üßÖ');
        }
    }, 1000);
});

        // Handler functions that can be called from HTML
        function addPlaceHandler() {
            console.log('Add place button clicked'); // Debug log
            
            const placeNameInput = document.getElementById('place-name');
            if (!placeNameInput) {
                console.error('Place name input not found');
                return;
            }
            
            const placeName = placeNameInput.value.trim();
            
            if (!placeName) {
                showNotification('Please enter a place name! üìù');
                return;
            }

            // Check for duplicate place names
            if (places.some(p => p.name.toLowerCase() === placeName.toLowerCase())) {
                showNotification('Place name already exists! Please choose a different name. üö´');
                return;
            }

            const place = {
                id: Date.now(),
                name: placeName,
                transactions: [],
                createdAt: new Date()
            };

            places.push(place);
            console.log('Place added:', place); // Debug log
            console.log('Total places:', places.length); // Debug log
            
            showNotification(`"${placeName}" added successfully! üéâ`);
            updatePlacesTable();
            updateStats();
            updateCharts();
            saveData();
            // Reset form
            placeNameInput.value = '';
        }

        // Data persistence functions
function saveData() {
    try {
        localStorage.setItem('sibuyasPlaces', JSON.stringify(places));
        localStorage.setItem('sibuyasCurrentPlace', currentPlace ? JSON.stringify(currentPlace) : null);
    } catch (error) {
        console.error('Error saving data:', error);
    }
}

function loadData() {
    try {
        const savedPlaces = localStorage.getItem('sibuyasPlaces');
        const savedCurrentPlace = localStorage.getItem('sibuyasCurrentPlace');
        
        if (savedPlaces) {
            places = JSON.parse(savedPlaces);
        }
        if (savedCurrentPlace && savedCurrentPlace !== 'null') {
            currentPlace = JSON.parse(savedCurrentPlace);
        }
    } catch (error) {
        console.error('Error loading data:', error);
        places = [];
        currentPlace = null;
    }
}

        function addTransactionHandler() {
    console.log('Add transaction button clicked'); // Debug log
    
    if (!currentPlace) {
        showNotification('Error: No place selected! üö´');
        return;
    }

    const nameInput = document.getElementById('transaction-name');
    const amountInput = document.getElementById('transaction-amount');
    const typeSelect = document.getElementById('transaction-type');
    const equityInput = document.getElementById('transaction-equity');
    
    if (!nameInput || !amountInput || !typeSelect || !equityInput) {
        console.error('Transaction form inputs not found');
        return;
    }
    
    const name = nameInput.value.trim();
    const amount = parseFloat(amountInput.value);
    const type = typeSelect.value;
    const equity = parseFloat(equityInput.value);

    // Validation
    if (!name) {
        showNotification('Please enter transaction name! üìù');
        return;
    }
    
    if (!amount || amount <= 0) {
        showNotification('Please enter a valid amount! üí∞');
        return;
    }
    
    if (!type) {
        showNotification('Please select payment type! üí≥');
        return;
    }

    if (!equity || equity < 0) {
        showNotification('Please enter a valid equity amount! üíπ');
        return;
    }

    // Show confirmation with equity details
    if (!confirm(`Confirm Transaction:\n\nName: ${name}\nAmount: ‚Ç±${amount.toLocaleString()}\nType: ${type.toUpperCase()}\nExpected Equity: ‚Ç±${equity.toLocaleString()}\n\nProceed?`)) {
        return;
    }

    const transaction = {
        id: Date.now(),
        name: name,
        amount: amount,
        type: type,
        equity: equity,
        date: new Date()
    };

    currentPlace.transactions.push(transaction);
    console.log('Transaction added:', transaction); // Debug log
    
    // Save data automatically
    saveData();
    
    showNotification(`Transaction "${name}" added! üí∞\nExpected Equity: ‚Ç±${equity.toLocaleString()} üíπ`);
    updateTransactionsList();
    updateStats();
    updateCharts();
    updatePlaceChart();
    
    // Reset form
    nameInput.value = '';
    amountInput.value = '';
    typeSelect.value = '';
    equityInput.value = '';
}  

        // Legacy functions (keeping for compatibility)
        function addPlace(e) {
            if (e) e.preventDefault();
            addPlaceHandler();
        }

        function addTransaction(e) {
            if (e) e.preventDefault();
            addTransactionHandler();
        }

        function updatePlacesTable() {
            const placesTable = document.getElementById('places-tbody');
            
            if (!placesTable) {
                console.error('Places table not found');
                return;
            }

            if (places.length === 0) {
                placesTable.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #999; padding: 40px;">
                            No places added yet. Add your first business location! üè™
                        </td>
                    </tr>`;
                return;
            }

            placesTable.innerHTML = places.map(place => {
                const totalTransactions = place.transactions.length;
                const revenue = place.transactions
                    .filter(t => t.type === 'cash')
                    .reduce((sum, t) => sum + t.amount, 0);
                const borrowed = place.transactions
                    .filter(t => t.type === 'borrowed')
                    .reduce((sum, t) => sum + t.amount, 0);
                const totalAmount = revenue + borrowed;
                const status = totalTransactions > 0 ? 'üü¢ Active' : 'üü° New';

                return `
                    <tr onclick="showPlace(${place.id})" style="cursor: pointer;">
                        <td><strong>${place.name}</strong></td>
                        <td>${totalTransactions}</td>
                        <td>‚Ç±${totalAmount.toLocaleString()}</td>
                        <td>${status}</td>
                    </tr>`;
            }).join('');
            
            console.log('Places table updated with', places.length, 'places'); // Debug log
        }

        function showPlace(placeId) {
            console.log('Showing place with ID:', placeId); // Debug log
            
            currentPlace = places.find(p => p.id === placeId);
            if (!currentPlace) {
                console.error('Place not found with ID:', placeId);
                showNotification('Error: Place not found! üö´');
                return;
            }

            const dashboardView = document.getElementById('dashboard-view');
            const placeView = document.getElementById('place-view');
            const placeTitle = document.getElementById('place-title');
            
            if (dashboardView && placeView && placeTitle) {
                placeTitle.innerHTML = `üßÖ ${currentPlace.name} - Add Transaction`;
                dashboardView.classList.add('hidden');
                placeView.classList.remove('hidden');
                
                updateTransactionsList();
                updatePlaceChart();
                
                console.log('Switched to place view for:', currentPlace.name); // Debug log
            } else {
                console.error('Required elements not found for place view');
            }
        }

        function showDashboard() {
            console.log('Showing dashboard'); // Debug log
            
            const dashboardView = document.getElementById('dashboard-view');
            const placeView = document.getElementById('place-view');
            
            if (dashboardView && placeView) {
                dashboardView.classList.remove('hidden');
                placeView.classList.add('hidden');
                currentPlace = null;
                
                // Refresh dashboard data
                updatePlacesTable();
                updateStats();
                updateCharts();
            }
        }

        function updateTransactionsList() {
            const container = document.getElementById('transactions-container');
            
            if (!container) {
                console.error('Transactions container not found');
                return;
            }
            
            if (!currentPlace || currentPlace.transactions.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: #999; padding: 40px;">
                        No transactions yet. Add your first transaction! üí∞
                    </p>`;
                return;
            }

           container.innerHTML = currentPlace.transactions
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .map(transaction => `
        <div class="transaction-item">
            <div class="transaction-header">
                <span class="transaction-name">${transaction.name}</span>
                <span class="transaction-amount">‚Ç±${transaction.amount.toLocaleString()}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                <span class="transaction-type ${transaction.type} ${transaction.paid ? 'paid' : ''}">${transaction.type.toUpperCase()}${transaction.paid ? ' - PAID' : ''}</span>
                <span style="background: #22C55E; color: white; padding: 4px 8px; border-radius: 10px; font-size: 0.8rem;">
                    Equity: ‚Ç±${(transaction.equity || 0).toLocaleString()}
                </span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    ${transaction.type === 'borrowed' && !transaction.paid ? 
                        `<button class="btn" style="padding: 4px 8px; font-size: 0.8rem;" onclick="markAsPaid(${transaction.id})">Mark as Paid</button>` : 
                        ''}
                </div>
                <span style="color: #999; font-size: 0.9rem;">
                    ${new Date(transaction.date).toLocaleDateString()}
                </span>
            </div>
        </div>
    `).join('');
                
            console.log('Transactions list updated with', currentPlace.transactions.length, 'transactions'); // Debug log
        }

        function updateStats() {
    const totalPlaces = places.length;
    const allTransactions = places.flatMap(p => p.transactions);
    const totalRevenue = allTransactions
        .filter(t => t.type === 'cash')
        .reduce((sum, t) => sum + t.amount, 0);
    const totalBorrowed = allTransactions
        .filter(t => t.type === 'borrowed' && !t.paid)
        .reduce((sum, t) => sum + t.amount, 0);
    const totalEquity = allTransactions
        .reduce((sum, t) => sum + (t.equity || 0), 0);
    const netProfit = totalRevenue - totalBorrowed;

    // Update DOM elements safely
    const elements = {
        'total-places': totalPlaces,
        'total-revenue': `‚Ç±${totalRevenue.toLocaleString()}`,
        'total-borrowed': `‚Ç±${totalBorrowed.toLocaleString()}`,
        'total-equity': `‚Ç±${totalEquity.toLocaleString()}`,
        'net-profit': `‚Ç±${netProfit.toLocaleString()}`
    };

    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    });
    
    console.log('Stats updated:', { totalPlaces, totalRevenue, totalBorrowed, totalEquity, netProfit }); // Debug log
}

        function updateCharts() {
            updateRevenueChart();
            updatePerformanceChart();
        }

        function updateRevenueChart() {
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            
            if (revenueChart) {
                revenueChart.destroy();
            }

            const allTransactions = places.flatMap(p => p.transactions);
            const revenue = allTransactions
                .filter(t => t.type === 'cash')
                .reduce((sum, t) => sum + t.amount, 0);
            const borrowed = allTransactions
    .filter(t => t.type === 'borrowed' && !t.paid)
    .reduce((sum, t) => sum + t.amount, 0);
            revenueChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cash Revenue', 'Borrowed Amount'],
                    datasets: [{
                        data: [revenue, borrowed],
                        backgroundColor: ['#22C55E', '#EF4444'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function getDailyLabels(startDate, endDate) {
    const labels = [];
    const current = new Date(startDate);
    
    while (current <= endDate) {
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        labels.push({
            label: dayNames[current.getDay()],
            endDate: new Date(current)
        });
        current.setDate(current.getDate() + 1);
    }
    
    return labels;
}

function getWeeklyLabels(startDate, endDate) {
    const labels = [];
    const current = new Date(startDate);
    let weekNumber = 1;
    
    while (current <= endDate) {
        const weekEnd = new Date(current);
        weekEnd.setDate(current.getDate() + 6);
        
        if (weekEnd > endDate) {
            weekEnd.setTime(endDate.getTime());
        }
        
        labels.push({
            label: `Week ${weekNumber}`,
            endDate: new Date(weekEnd)
        });
        
        current.setDate(current.getDate() + 7);
        weekNumber++;
    }
    
    return labels;
}

function getMonthlyLabels(startDate, endDate) {
    const labels = [];
    const current = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    while (current <= endDate) {
        const monthEnd = new Date(current.getFullYear(), current.getMonth() + 1, 0);
        
        if (monthEnd > endDate) {
            monthEnd.setTime(endDate.getTime());
        }
        
        labels.push({
            label: monthNames[current.getMonth()],
            endDate: new Date(monthEnd)
        });
        
        current.setMonth(current.getMonth() + 1);
    }
    
    return labels;
}

        function updatePerformanceChart() {
    const ctx = document.getElementById('performance-chart').getContext('2d');
    
    if (performanceChart) {
        performanceChart.destroy();
    }

    // Get all transactions and sort by date
    const allTransactions = places.flatMap(p => p.transactions).sort((a, b) => new Date(a.date) - new Date(b.date));
    
    if (allTransactions.length === 0) {
        // Show empty chart with message
        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['No Data'],
                datasets: [{
                    label: 'Revenue',
                    data: [0],
                    borderColor: '#22C55E',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Outstanding Borrowed',
                    data: [0],
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Add transactions to see performance trend'
                    }
                }
            }
        });
        return;
    }

    const labels = [];
    const revenueData = [];
    const borrowedData = [];
    
    // Get date range
    const firstDate = new Date(allTransactions[0].date);
    const lastDate = new Date(allTransactions[allTransactions.length - 1].date);
    const today = new Date();
    
    // Determine date range based on period and actual data
    let startDate, endDate, dateLabels;
    
    if (currentPeriod === 'week') {
        // Show last 7 days or since first transaction
        endDate = new Date(today);
        startDate = new Date(today);
        startDate.setDate(today.getDate() - 6);
        
        // If first transaction is more recent, start from there
        if (firstDate > startDate) {
            startDate = new Date(firstDate);
        }
        
        dateLabels = getDailyLabels(startDate, endDate);
    } else if (currentPeriod === 'month') {
        // Show last 4 weeks or since first transaction
        endDate = new Date(today);
        startDate = new Date(today);
        startDate.setDate(today.getDate() - 27); // 4 weeks
        
        if (firstDate > startDate) {
            startDate = new Date(firstDate);
        }
        
        dateLabels = getWeeklyLabels(startDate, endDate);
    } else {
        // Show last 12 months or since first transaction
        endDate = new Date(today);
        startDate = new Date(today);
        startDate.setMonth(today.getMonth() - 11);
        
        if (firstDate > startDate) {
            startDate = new Date(firstDate);
        }
        
        dateLabels = getMonthlyLabels(startDate, endDate);
    }

    // Calculate cumulative data for each period
    dateLabels.forEach(period => {
        labels.push(period.label);
        
        // Get transactions up to this period
        const transactionsUpToPeriod = allTransactions.filter(t => {
            const transactionDate = new Date(t.date);
            return transactionDate <= period.endDate;
        });
        
        // Calculate cumulative revenue
        const cumulativeRevenue = transactionsUpToPeriod
            .filter(t => t.type === 'cash')
            .reduce((sum, t) => sum + t.amount, 0);
        
        // Calculate outstanding borrowed (borrowed - paid)
        const outstandingBorrowed = transactionsUpToPeriod
            .filter(t => t.type === 'borrowed' && !t.paid)
            .reduce((sum, t) => sum + t.amount, 0);
        
        revenueData.push(cumulativeRevenue);
        borrowedData.push(outstandingBorrowed);
    });

    performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cumulative Revenue',
                data: revenueData,
                borderColor: '#22C55E',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Outstanding Borrowed',
                data: borrowedData,
                borderColor: '#EF4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '‚Ç±' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ‚Ç±' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

        function updatePlaceChart() {
            if (!currentPlace) return;

            const ctx = document.getElementById('place-chart').getContext('2d');
            
            if (placeChart) {
                placeChart.destroy();
            }

            const transactions = currentPlace.transactions;
            const revenue = transactions
                .filter(t => t.type === 'cash')
                .reduce((sum, t) => sum + t.amount, 0);
            const borrowed = transactions
    .filter(t => t.type === 'borrowed' && !t.paid)
    .reduce((sum, t) => sum + t.amount, 0);

            placeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Cash', 'Borrowed'],
                    datasets: [{
                        label: 'Amount (‚Ç±)',
                        data: [revenue, borrowed],
                        backgroundColor: ['#22C55E', '#EF4444'],
                        borderColor: ['#16A34A', '#DC2626'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç±' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            if (notification && notificationMessage) {
                notificationMessage.textContent = message;
                notification.classList.add('show');
                
                // Auto-hide after 4 seconds
                setTimeout(() => {
                    hideNotification();
                }, 4000);
                
                console.log('Notification shown:', message); // Debug log
            }
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.classList.remove('show');
            }
        }

        // Make functions globally accessible
        window.addPlaceHandler = addPlaceHandler;
        window.addTransactionHandler = addTransactionHandler;
        window.showPlace = showPlace;
        window.showDashboard = showDashboard;
        window.hideNotification = hideNotification;
        window.markAsPaid = markAsPaid;

        // Performance period buttons event listener
        document.addEventListener('DOMContentLoaded', function() {
            // Performance period buttons
            document.querySelectorAll('.performance-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.performance-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentPeriod = e.target.dataset.period;
                    updateCharts();
                });
            });
        });
        function markAsPaid(transactionId) {
    if (!currentPlace) return;
    
    const transaction = currentPlace.transactions.find(t => t.id === transactionId);
    if (!transaction) {
        showNotification('Transaction not found! üö´');
        return;
    }
    
    if (transaction.type !== 'borrowed') {
        showNotification('Only borrowed transactions can be marked as paid! üö´');
        return;
    }
    
    if (transaction.paid) {
        showNotification('Transaction is already marked as paid! ‚úÖ');
        return;
    }
    
    transaction.paid = true;
    transaction.paidDate = new Date();
    
    showNotification(`"${transaction.name}" marked as paid! ‚úÖ`);
    updateTransactionsList();
    updateStats();
    updateCharts();
    updatePlaceChart();
    saveData();
}
    </script>
</body>
</html>
